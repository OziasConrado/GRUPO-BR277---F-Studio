rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Public read for assets that need to be universally available.
    // This simplifies management for non-sensitive public assets.
    match /public/{allPaths=**} {
        allow read;
    }

    // A single, secure rule to govern all user-generated content.
    // This rule covers all subdirectories like 'profile_pictures', 'images', 'videos', etc.
    // The {path} wildcard matches the top-level directory (e.g., 'images').
    // The {userId} wildcard is crucial for the security rule.
    match /{path}/{userId}/{allPaths=**} {
      
      // Allow anyone to read any user-uploaded file. This is necessary for profile pictures,
      // post images, etc., to be visible to all other users in the app.
      allow read;

      // Allow write operations (create, update, delete) ONLY IF:
      // 1. The user is authenticated (request.auth != null).
      // 2. The userId in the file path exactly matches the authenticated user's ID.
      //    This is the "stamp" or "license" check that ensures users can only write to their own folders.
      // 3. The file being uploaded is less than 50MB. This prevents abuse.
      allow write: if request.auth != null &&
                      request.auth.uid == userId &&
                      request.resource.size < 50 * 1024 * 1024;
    }
  }
}
