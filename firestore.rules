
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if the user is an admin
    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }

    // Banners: Admin can write. Public can read active ones. Admin can list all.
    match /banners/{bannerId} {
      // Allow admin to list all banners, public can only list active banners
      allow list: if isAdmin() || (request.query.where == null || request.query.where.isActive == true);
      // Allow admin to read any banner, public can only read active ones
      allow get: if isAdmin() || resource.data.isActive == true;
      // Allow only admin to create, update, delete
      allow create, update, delete: if isAdmin();
    }

    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }

    match /posts/{postId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.userId);

      match /comments/{commentId} {
        allow read: if true;
        allow create: if isAuthenticated();
        allow update, delete: if isOwner(resource.data.userId);
      }

<<<<<<< HEAD
      // Reactions on posts
      match /userReactions/{userId} {
        allow read: if true;
        // Only the authenticated user can manage their own reaction
        allow write: if isOwner(userId);
      }
      
      // Votes on polls inside posts
=======
      match /userReactions/{userId} {
        allow read: if true;
        allow write: if isOwner(userId);
      }
      
>>>>>>> 0538a4f5ad6dbfd4d734ab1f85ddcbef9397e196
      match /userVotes/{userId} {
         allow read: if true;
         allow write: if isOwner(userId);
      }
    }

    match /reels/{reelId} {
      allow read: if resource.data.deleted != true;
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.authorId);

      match /comments/{commentId} {
        allow read: if true;
        allow create: if isAuthenticated();
        allow update, delete: if isOwner(resource.data.userId);
      }

<<<<<<< HEAD
      // Reactions on reels
      match /userReactions/{userId} {
        allow read: if true;
        // Only the authenticated user can manage their own reaction
=======
      match /userReactions/{userId} {
        allow read: if true;
>>>>>>> 0538a4f5ad6dbfd4d734ab1f85ddcbef9397e196
        allow write: if isOwner(userId);
      }
    }

    match /alerts/{alertId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if false; 
    }
    
    match /banners/{bannerId} {
      allow list: if isAdmin();
      allow read: if true;
      allow write: if isAdmin();
    }

    match /businesses/{businessId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.ownerId);
      allow delete: if false;
    }

    match /sau_reviews/{reviewId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.userId);
    }
    
    match /tourist_points_indicated/{pointId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.indicatedByUserId);
    }

    match /tourist_point_reviews/{reviewId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.userId);
    }

    match /users/{userId} { 
      allow read: if isAuthenticated();
<<<<<<< HEAD
      // Only the user whose profile it is can create/update it
      allow create, update: if request.auth.uid == userId;
      allow delete: if false; // Users cannot delete their own profiles via client
=======
      allow create, update: if request.auth.uid == userId;
      allow delete: if false;
>>>>>>> 0538a4f5ad6dbfd4d734ab1f85ddcbef9397e196

      match /notifications/{notificationId} {
        allow read, update, delete: if isOwner(userId);
        allow create: if isAuthenticated(); 
      }
    }

    match /chatMessages/{messageId} {
      allow read, create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.userId);

      match /userReactions/{reactionId} {
        allow read: if true;
        allow create, update, delete: if reactionId == request.auth.uid;
      }
    }
  }
}
