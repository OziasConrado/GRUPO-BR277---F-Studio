rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is authenticated.
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to check if the request is coming from the Admin SDK.
    function isAdmin() {
      // This is a common way to check for admin access in security rules.
      // It assumes you don't expose session tokens to your backend.
      // A more robust way if needed is to check a custom claim on the user's token.
      return request.auth.token.email_verified == true; 
    }

    // --- Feed (Posts, Reels, Alerts) ---
    match /posts/{postId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;

      // Rules for subcollections of posts
      match /comments/{commentId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      }
      match /userReactions/{userId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isSignedIn() && userId == request.auth.uid;
      }
    }
    
    match /reels/{reelId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }
    
    match /alerts/{alertId} {
      allow read: if isSignedIn();
      // Allow any signed-in user to create an alert
      allow create: if isSignedIn();
      // Only the user who created it can delete it (adjust if admins can)
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // --- Guia Comercial & Pagamentos ---
    match /businesses/{businessId} {
      allow read: if true; // Publicly readable
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      // Allow owner to update. Admin (backend) can update for payment status.
      allow update: if isSignedIn() && (resource.data.ownerId == request.auth.uid || isAdmin());
    }

    // --- SAU (Serviço de Atendimento ao Usuário) ---
    match /sau_reviews/{reviewId} {
      allow read: if true; // Publicly readable
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
    }

    // --- Turismo ---
    match /tourist_points_indicated/{pointId} {
      allow read: if true; // Publicly readable
      // Allow authenticated users to create indications
      allow create: if isSignedIn() && request.resource.data.indicatedByUserId == request.auth.uid;
      // Allow admin to update status
      allow update: if isAdmin();
    }

    match /tourist_point_reviews/{reviewId} {
      allow read: if true; // Publicly readable
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
    }

    // --- Chat ---
    match /chatMessages/{messageId} {
      allow read, create: if isSignedIn();
      allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;

      // Subcollections for reactions
      match /userReactions/{userId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isSignedIn() && userId == request.auth.uid;
      }
      match /commentReactions/{userId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isSignedIn() && userId == request.auth.uid;
      }
    }

    // --- Coleção de Usuários ---
    match /Usuários/{userId} {
      // Anyone can read a user's public profile data
      allow read: if true;
      // A user can create their own profile document
      allow create: if isSignedIn() && userId == request.auth.uid;
      // A user can only update their own profile
      allow update, delete: if isSignedIn() && userId == request.auth.uid;

      // Subcollection for user notifications
      match /notifications/{notificationId} {
        allow read, update, delete: if isSignedIn() && userId == request.auth.uid;
        // Prevent creation from client-side for security
        allow create: if false; 
      }
    }
  }
}
