rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Regras para a coleção de usuários
    match /Usuarios/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Regras para os posts do feed
    match /posts/{postId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Regras para comentários em posts
      match /comments/{commentId} {
        allow read: if true;
        allow create: if request.auth != null;
        allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      }
      
      // Regras para reações (votos) em posts
      match /userReactions/{userId} {
      	allow read: if true;
        allow create, write, delete: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Regras para os reels (stories)
    match /reels/{reelId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.authorId == request.auth.uid;

      // Regras para comentários em reels
      match /comments/{commentId} {
        allow read: if true;
        allow create: if request.auth != null;
        allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      }
      
      // Regras para reações em reels
       match /userReactions/{userId} {
      	 allow read: if true;
         allow create, write, delete: if request.auth != null && request.auth.uid == userId;
       }
    }

    // Regras para mensagens do chat
    match /chatMessages/{messageId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Regras para reações em mensagens
      match /userReactions/{userId} {
      	allow read: if true;
        allow create, write, delete: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Regras para alertas
    match /alerts/{alertId} {
      allow read: if true;
      allow create: if request.auth != null;
      // Idealmente, apenas administradores podem apagar. Por enquanto, desabilitado.
      allow update, delete: if false; 
    }
    
    // Regras para o Guia Comercial
    match /businesses/{businessId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      allow update: if request.auth != null && resource.data.ownerId == request.auth.uid;
      allow delete: if false; // Ninguém pode deletar diretamente, deve ser via lógica de negócio
    }

    // Regras para avaliações de SAU
    match /sau_reviews/{reviewId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // Regras para pontos turísticos indicados
    match /tourist_points_indicated/{pointId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.indicatedByUserId == request.auth.uid;
      // Apenas admin pode aprovar/editar, e o usuário dono pode (talvez) editar antes da aprovação.
      allow update: if request.auth != null && resource.data.indicatedByUserId == request.auth.uid;
      allow delete: if false;
      
      // Regras para avaliações de pontos turísticos
      match /tourist_point_reviews/{reviewId} {
        allow read: if true;
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
        allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      }
    }
    
    // Regras para enquetes em posts
    match /posts/{postId}/userVotes/{userId} {
      allow read: if true;
      allow create, write, delete: if request.auth != null && request.auth.uid == userId;
    }

    // Regras para notificações
    match /Usuarios/{userId}/notifications/{notificationId} {
      allow read, write, update, delete: if request.auth != null && request.auth.uid == userId;
    }
  }
}
