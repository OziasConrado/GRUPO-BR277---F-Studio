
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if the user is the owner of the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    //----------------------------------------------------------------------
    // Usuários Collection
    //----------------------------------------------------------------------
    match /Usuários/{userId} {
      // Um usuário pode ler seu próprio perfil.
      // O backend (usando a conta de serviço) pode ler qualquer perfil.
      allow read: if isAuthenticated();

      // Um usuário pode criar e atualizar seu próprio perfil.
      allow create, update: if isOwner(userId);
    }

    //----------------------------------------------------------------------
    // Posts Collection (Feed)
    //----------------------------------------------------------------------
    match /posts/{postId} {
      // Qualquer usuário autenticado pode ler os posts.
      allow read: if isAuthenticated();

      // Usuário pode criar um post se estiver autenticado.
      // E só pode atualizar/deletar se for o dono do post.
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && isOwner(resource.data.userId);

      // Subcoleções de comentários e reações
      match /comments/{commentId} {
        allow read, create: if isAuthenticated();
        allow update, delete: if isAuthenticated() && isOwner(resource.data.userId);
      }
      match /userReactions/{userId} {
        allow read, create, update, delete: if isAuthenticated() && isOwner(userId);
      }
      match /userVotes/{userId} {
        allow read, create, update, delete: if isAuthenticated() && isOwner(userId);
      }
    }

    //----------------------------------------------------------------------
    // Reels Collection (Stories)
    //----------------------------------------------------------------------
    match /reels/{reelId} {
      allow read, create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && isOwner(resource.data.authorId);

      match /comments/{commentId} {
        allow read, create: if isAuthenticated();
        allow update, delete: if isAuthenticated() && isOwner(resource.data.userId);
      }
       match /userReactions/{userId} {
        allow read, create, update, delete: if isAuthenticated() && isOwner(userId);
      }
    }

    //----------------------------------------------------------------------
    // Alerts Collection
    //----------------------------------------------------------------------
    match /alerts/{alertId} {
      // Qualquer usuário autenticado pode ler os alertas.
      allow read: if isAuthenticated();
      // Qualquer usuário autenticado pode criar um alerta.
      allow create: if isAuthenticated();
      // Apenas o dono pode deletar (ou admin no futuro).
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    //----------------------------------------------------------------------
    // Chat Messages Collection
    //----------------------------------------------------------------------
    match /chatMessages/{messageId} {
        allow read, create: if isAuthenticated();
        // Apenas o dono da mensagem pode editar ou deletar.
        allow update, delete: if isAuthenticated() && isOwner(resource.data.userId);
        
        match /userReactions/{userId} {
            allow read, create, update, delete: if isAuthenticated() && isOwner(userId);
        }
    }

    //----------------------------------------------------------------------
    // Businesses Collection (Guia Comercial)
    //----------------------------------------------------------------------
    match /businesses/{businessId} {
      // Todos podem ler os estabelecimentos.
      allow read: if true;
      // Apenas usuários autenticados podem criar.
      allow create: if isAuthenticated();
      // Apenas o dono do estabelecimento pode atualizar ou deletar.
      allow update, delete: if isAuthenticated() && isOwner(resource.data.ownerId);
    }

    //----------------------------------------------------------------------
    // SAU Reviews Collection
    //----------------------------------------------------------------------
    match /sau_reviews/{reviewId} {
        // Todos podem ler as avaliações.
        allow read: if true;
        // Apenas usuários autenticados podem criar avaliações.
        allow create: if isAuthenticated();
    }
    
    //----------------------------------------------------------------------
    // Tourist Points & Reviews
    //----------------------------------------------------------------------
    match /tourist_points_indicated/{pointId} {
        // Todos podem ler os pontos turísticos.
        allow read: if true;
        // Apenas usuários autenticados podem criar.
        allow create: if isAuthenticated();
        // Apenas o dono da indicação ou um admin (futuro) pode atualizar/deletar.
        allow update, delete: if isAuthenticated() && isOwner(resource.data.indicatedByUserId);
        
        match /userVotes/{userId} {
          allow read, create, delete: if isAuthenticated() && isOwner(userId);
        }
    }

    match /tourist_point_reviews/{reviewId} {
        // Todos podem ler as avaliações.
        allow read: if true;
        // Apenas usuários autenticados podem criar.
        allow create: if isAuthenticated();
    }
  }
}
