rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Regra Geral: Bloqueia por padrão
    match /{document=**} {
      allow read, write: if false;
    }

    // Coleção Usuarios
    match /Usuarios/{userId} {
      allow read: if true;
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId;

      // Subcoleção de notificações
      match /notifications/{notificationId} {
        allow read, update, delete: if request.auth.uid == userId;
      }
    }
    
    // Coleção de Posts
    match /posts/{postId} {
      allow read: if true;
      allow create: if request.auth != null;
      // Permite que o autor atualize o post, incluindo marcá-lo como deletado
      allow update: if request.auth.uid == resource.data.userId;
      
      // Permite que qualquer usuário autenticado atualize APENAS o campo de reações
      allow update: if request.auth != null && request.resource.data.keys().hasOnly(['reactions']);

      // Subcoleção de comentários
      match /comments/{commentId} {
        allow read: if true;
        allow create: if request.auth != null;
        // Permite que o autor do comentário atualize
        allow update: if request.auth.uid == resource.data.userId;
        // Permite que qualquer usuário autenticado atualize APENAS as reações do comentário
        allow update: if request.auth != null && request.resource.data.keys().hasOnly(['reactions']);
      }
      
      // Subcoleção de reações do post
      match /userReactions/{userId} {
        allow read, create, delete: if request.auth.uid == userId;
      }
    }

    // Coleção de Reels
    match /reels/{reelId} {
        allow read: if true;
        allow create: if request.auth != null;
        allow update: if request.auth.uid == resource.data.userId;

        // Reações no Reel
        match /userReactions/{userId} {
            allow read, create, delete: if request.auth.uid == userId;
        }

        // Comentários no Reel
        match /comments/{commentId} {
            allow read: if true;
            allow create: if request.auth != null;
            allow update: if request.auth.uid == resource.data.userId;
        }
    }

    // Coleção de Alertas
    match /alerts/{alertId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      // Permite que o autor do alerta (ou um admin no futuro) delete
      allow delete, update: if request.auth.uid == resource.data.userId;
    }
    
    // **NOVA REGRA CORRIGIDA**
    // Permite que usuários autenticados listem os alertas na página inicial
    match /alerts/{alertId} {
      allow list: if request.auth != null;
    }

    // Coleção de Avaliações de SAUs
    match /sau_reviews/{reviewId} {
        allow read: if true;
        allow create: if request.auth != null;
    }
    
    // Coleção de Chat
    match /chatMessages/{messageId} {
        allow read: if true;
        allow create: if request.auth != null;
        allow update: if request.auth.uid == resource.data.userId;
        allow delete: if request.auth.uid == resource.data.userId;
        
        // Reações nas mensagens do chat
        match /userReactions/{userId} {
          allow read, create, delete: if request.auth.uid == userId;
        }
    }

    // Coleção de Pontos Turísticos
    match /tourist_points_indicated/{pointId} {
        allow read: if true;
        allow create: if request.auth != null;
        // Permite atualizar contagem de reviews e rating
        allow update: if request.auth != null; 
    }

    // Coleção de Avaliações de Pontos Turísticos
    match /tourist_point_reviews/{reviewId} {
        allow read: if true;
        allow create: if request.auth != null;
    }

    // Votos em enquetes
    match /posts/{postId}/userVotes/{userId} {
        allow read, create: if request.auth.uid == userId;
    }

    // Reações em comentários de posts
    match /posts/{postId}/comments/{commentId}/commentReactions/{userId} {
        allow read, create, delete: if request.auth.uid == userId;
    }
    
    // Reações em comentários de reels
    match /reels/{reelId}/comments/{commentId}/commentReactions/{userId} {
        allow read, create, delete: if request.auth.uid == userId;
    }
  }
}
