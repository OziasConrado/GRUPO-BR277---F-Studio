
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Coleções com Leitura Pública ---

    // Todos podem ler os pontos de atendimento (SAUs)
    match /sau_locations/{sauId} {
      allow read: if true;
      allow write: if false; // Bloqueia escrita direta
    }

    // Todos podem ler os pontos turísticos aprovados
    match /tourist_points_indicated/{pointId} {
      allow read: if resource.data.status == 'approved';
      allow create: if request.auth != null; // Qualquer usuário logado pode criar (indicar)
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.indicatedByUserId; // O autor pode editar/deletar sua indicação
    }

    // Todos podem ler as avaliações de turismo e SAU
    match /tourist_point_reviews/{reviewId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /sau_reviews/{reviewId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Todos podem ler os posts que não foram deletados
    match /posts/{postId} {
      allow read: if resource.data.deleted == false;
      allow create: if request.auth != null;
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      // Reações (votos)
      match /userReactions/{userId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      // Comentários
      match /comments/{commentId} {
        allow read: if true;
        allow create: if request.auth != null;
        allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
        match /commentReactions/{reactionUserId} {
          allow read, write: if request.auth != null && request.auth.uid == reactionUserId;
        }
      }
    }
    
    // Todos podem ler os reels que não foram deletados
    match /reels/{reelId} {
        allow read: if resource.data.deleted == false;
        allow create: if request.auth != null;
        allow update: if request.auth != null && request.auth.uid == resource.data.authorId;
        allow delete: if request.auth != null && request.auth.uid == resource.data.authorId;

        // Reações e comentários dos reels
        match /userReactions/{userId} {
            allow read, write: if request.auth != null && request.auth.uid == userId;
        }
        match /comments/{commentId} {
            allow read: if true;
            allow create: if request.auth != null;
            allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
        }
    }

    // Todos podem ler os alertas
    match /alerts/{alertId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId; // Se houver um dono
    }
    
    // --- Coleções com Acesso Restrito ---
    
    // Usuários: Um usuário pode ler qualquer perfil, mas só pode escrever/editar o seu próprio.
    match /Usuários/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      
      // Subcoleção de notificações
      match /notifications/{notificationId} {
        allow read, write, delete: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Mensagens do Chat: Apenas usuários autenticados podem ler e escrever.
    match /chatMessages/{messageId} {
        allow read, create: if request.auth != null;
        allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
        
        // Reações das mensagens
        match /userReactions/{userId} {
            allow read, write: if request.auth != null && request.auth.uid == userId;
        }
    }
    
    // Guia Comercial: Todos podem ler, mas apenas o dono pode editar seu negócio.
    match /businesses/{businessId} {
        allow read: if true;
        allow create: if request.auth != null; // Qualquer usuário logado pode iniciar o cadastro
        allow update: if request.auth != null && request.auth.uid == resource.data.ownerId; // Apenas o dono pode editar
        
        // Votos de enquete
        match /userVotes/{userId} {
            allow read, write: if request.auth != null && request.auth.uid == userId;
        }
    }
  }
}
